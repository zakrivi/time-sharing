var timeSharing=function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function n(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return c(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var l=!/ipad|iphone|midp|rv:1.2.3.4|ucweb|android|windows ce|windows mobile/.test(navigator.userAgent.toLowerCase()),u=window.devicePixelRatio,h=l?{start:"mousedown",end:"mouseup",move:"mousemove",leave:"mouseleave"}:{start:"touchstart",end:"touchend",move:"touchmove"};function f(e){var t=g({closePrice:e.closePrice,computedHighPrice:e.computedHighPrice,computedLowPrice:e.computedLowPrice});return t.upperPoint-t.bottomPoint}function g(e){var t=e.closePrice,i=function(e){var t=e.closePrice,i=e.computedHighPrice,n=e.computedLowPrice;return 1.15*Math.max(Math.abs(i-t),Math.abs(n-t))}({closePrice:t,computedHighPrice:e.computedHighPrice,computedLowPrice:e.computedLowPrice});return{upperPoint:t+i,bottomPoint:t-i}}function d(e){var t=e.rawData,i=e.zoomX,n=e.closePrice,r=e.computedHighPrice,o=e.computedLowPrice,s=e.size,c=e.tradingLength,l=e.debug,u=c<=s.containerWidth?1:c/(s.containerWidth+1),h=[];if(!t.length)return[];for(var f=[],g=0,d=!1,C=Math.floor(u),x=u%C,m=0;g<t.length;)f.push(t[g]),g===t.length-1&&(d=!0),g+=C,(m+=x)>=1&&(g+=Math.floor(m),m-=Math.floor(m));if(d||f.push(t[t.length-1]),h=f.map((function(e,t){return a(a({},e),{},{x:p(t,i),y:v(e.price,{closePrice:n,computedHighPrice:r,computedLowPrice:o,size:s})})})),l&&h.length){var w=h.map((function(e){var t=new Date(1e3*e.time),i=t.getMonth()+1,n=t.getDate(),r=t.getHours(),o=t.getMinutes();return["".concat(i,"/").concat(n," ").concat(r,":").concat(o),e.time,e.price]}));console.log({times:w})}return h}function v(e,t){var i=t.closePrice,n=t.computedHighPrice,r=t.computedLowPrice,o=t.size,a=f({closePrice:i,computedHighPrice:n,computedLowPrice:r});return Math.round((1-(e-i+a/2)/a)*o.areaCtxHeight)}function p(e,t){return e*t}function C(e,t){var i=e.x,n=e.zoomX,r=Math.round(i/n);return t[r]?t[r]:null}var x=l?function(e){return{x:e.offsetX*u,y:e.offsetY*u}}:function(e,t){return{x:(e.targetTouches[0].pageX-t.areaRect.left)*u,y:(e.targetTouches[0].pageY-t.areaRect.top)*u}};function m(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return/^(\-|\+)?\d+(\.\d+)?$/.test(e)?w(e,t):"- -"}function w(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,i=Math.pow(10,t),n=0;return n=e>0?e*i+.5:e*i-.5,n=parseInt(n,10)/i,Number(n).toFixed(t)}var b=function(){function e(){t(this,e),this._subscribers={}}return n(e,[{key:"subscribe",value:function(e,t){!this._subscribers[e]&&(this._subscribers[e]=[]),this._subscribers[e].push(t)}},{key:"unSubscribe",value:function(e){delete this._subscribers[e]}},{key:"publish",value:function(e,t){Array.isArray(this._subscribers[e])&&this._subscribers[e].forEach((function(e){return e(t)}))}}]),e}();var y=new(function(){function e(){return t(this,e),e._instance||(this.init(),e._instance=this),e._instance}return n(e,[{key:"init",value:function(){this._config={zoomX:u,rawData:[],kList:[],highPrice:null,lowPrice:null,closePrice:null,computedHighPrice:null,computedLowPrice:null,digit:2,startTime:"",endTime:"",tradingLength:0,size:{containerWidth:null,areaCtxWidth:null,areaCtxHeight:null},font:{normal:"".concat(12*u,"px sans-serif")},colors:{up:"red",down:"green"},nodes:{}}}},{key:"update",value:function(e){var t=this;Object.keys(e).forEach((function(i){t._config[i]=e[i]}));var i=this._config,n=i.highPrice,r=i.lowPrice,o=i.rawData;this._config.computedHighPrice=n||function(e){var t=e.rawData;return Math.max.apply(Math,s(t.map((function(e){return e.price}))))}({rawData:o}),this._config.computedLowPrice=r||function(e){var t=e.rawData;return Math.min.apply(Math,s(t.map((function(e){return e.price}))))}({rawData:o})}},{key:"getConfig",value:function(){return this._config}}]),e}()),P=function(){function e(i){t(this,e),this._init(i)}return n(e,[{key:"_init",value:function(e){this._canvas=y.getConfig().nodes.area,this._canvas.style.cssText="position: absolute;top: 0;left: 0;width: 100%;height: 100%;",this._options=e,this.ctx=this._canvas.getContext("2d")}},{key:"draw",value:function(){if(0!==y.getConfig().kList.length){var e=this.ctx;e.clearRect(0,0,y.getConfig().size.areaCtxWidth,y.getConfig().size.areaCtxHeight),e.fillStyle="#fff",e.fillRect(0,0,y.getConfig().size.areaCtxWidth,y.getConfig().size.areaCtxHeight),e.save(),e.beginPath(),e.lineWidth=1*u,y.getConfig().kList.forEach((function(t,i){e.lineTo(t.x,t.y)})),e.strokeStyle="rgb(71, 127, 211)",e.stroke(),e.lineTo(y.getConfig().kList[y.getConfig().kList.length-1].x,y.getConfig().size.areaCtxHeight),y.getConfig().kList.length&&e.lineTo(y.getConfig().kList[0].x,y.getConfig().size.areaCtxHeight);var t=e.createLinearGradient(0,0,0,y.getConfig().size.areaCtxHeight);t.addColorStop(0,"rgba(61,114,228,0.5)"),t.addColorStop(1,"rgba(61,114,228,0.01)"),e.fillStyle=t,e.fill(),e.restore(),this._drawOpenLine(),this._drawPoint()}}},{key:"_drawOpenLine",value:function(){var e=this.ctx,t=Math.round(y.getConfig().size.areaCtxHeight/2);e.save(),e.beginPath(),e.translate(.5,.5),e.lineWidth=1*u,e.moveTo(0,t),e.lineTo(y.getConfig().size.areaCtxWidth,t),e.setLineDash([4*u,4*u]),e.lineDashOffset=0,e.strokeStyle="rgba(200, 200, 200, 1)",e.stroke(),e.font=y.getConfig().font.normal,e.textAlign="left",e.fillStyle="#666",e.fillText(m(y.getConfig().closePrice,y.getConfig().digit),12*u,y.getConfig().size.areaCtxHeight/2-5*u),e.textAlign="right",e.fillStyle="#aaa",e.fillText(m(0,2)+"%",y.getConfig().size.areaCtxWidth-12*u,y.getConfig().size.areaCtxHeight/2-5*u),e.restore()}},{key:"_drawPoint",value:function(){var e=this.ctx,t=y.getConfig(),i=t.closePrice,n=t.size,r=t.digit,o=t.colors,a=g({closePrice:i,computedHighPrice:t.computedHighPrice,computedLowPrice:t.computedLowPrice}),s=a.upperPoint,c=a.bottomPoint,l=(s-i)/i*100,h=(c-i)/i*100;e.save(),e.font=y.getConfig().font.normal,e.fillStyle=o.up,e.textAlign="left",e.fillText(m(s,r),12*u,16*u),e.textAlign="right",e.fillText(m(l,2)+"%",n.areaCtxWidth-12*u,16*u),e.fillStyle=o.down,e.textAlign="left",e.fillText(m(c,r),12*u,n.areaCtxHeight-6*u),e.textAlign="right",e.fillText(m(h,2)+"%",n.areaCtxWidth-12*u,n.areaCtxHeight-6*u),e.restore()}}]),e}(),_=function(){function e(i){t(this,e),this._canvas=y.getConfig().nodes.areaCross,this._canvas.style.cssText="position: absolute;top: 0;left: 0;width: 100%;height: 100%;",this.ctx=this._canvas.getContext("2d"),this._options=i,this._crossE=null,this.isShowCross=!1,this._drawRound()}return n(e,[{key:"draw",value:function(e){e&&(this._crossE=e),this.ctx.clearRect(0,0,y.getConfig().size.areaCrossCtxWidth,y.getConfig().size.areaCrossCtxHeight),this.isShowCross&&(e||this._crossE)&&this._drawCrossLine(e)}},{key:"_drawCrossLine",value:function(e){var t=this.ctx,i=y.getConfig(),n=i.digit,r=i.closePrice,o=i.size,a=i.font,s=i.computedHighPrice,c=i.computedLowPrice,l=x(e||this._crossE,o),h=Math.round(l.x),g=Math.round(l.y);t.save(),t.beginPath(),t.translate(.5/u,.5/u),t.setLineDash([5*u,8*u]),t.lineDashOffset=0,t.lineWidth=1*u,t.strokeStyle="#000",t.moveTo(0,g),t.lineTo(o.areaCrossCtxWidth,g),t.moveTo(h,0),t.lineTo(h,y.getConfig().size.areaCrossCtxHeight),t.stroke(),t.restore();var d=m(function(e,t){var i=t.closePrice,n=t.computedHighPrice,r=t.computedLowPrice,o=t.size,a=f({closePrice:i,computedHighPrice:n,computedLowPrice:r});return(1-e/o.areaCtxHeight)*a-a/2+i}(g,{closePrice:r,computedHighPrice:s,computedLowPrice:c,size:o}),n),v=m((d-r)/r*100,2)+"%";t.save(),t.beginPath(),t.font=a.normal,t.textAlign="left",t.fillStyle="#333",t.fillText(d,12*u,g-4*u),t.beginPath(),t.font=a.normal,t.textAlign="right",t.fillStyle="#333",t.fillText(v,o.areaCrossCtxWidth-12*u,g-5*u),t.restore(),this._drawColumnPrice(e)}},{key:"_drawColumnPrice",value:function(e){var t=this.ctx,i=y.getConfig(),n=i.size,r=i.kList,o=i.closePrice,a=i.zoomX,s=x(e||this._crossE,n).x,c=C({x:s,zoomX:a},r);if(c){var l=c.price,h=c.y;t.save(),t.translate(.5,.5),t.beginPath(),t.lineWidth=1*u,t.arc(s,h,3*u,0,2*Math.PI,!1),t.fillStyle="#f6822f",t.fill(),t.beginPath(),t.moveTo(0,h),t.lineTo(n.areaCrossCtxWidth,h),t.setLineDash([5*u,5*u]),t.lineDashOffset=0,t.strokeStyle="#f6822f",t.stroke(),t.font=y.getConfig().font.normal,t.fillStyle="#f6822f",t.textAlign="center",t.fillText(l,30*u,h-5*u);var f=(l-o)/o*100;t.textAlign="right",t.fillText(m(f,2)+"%",n.areaCrossCtxWidth-12*u,h-5*u),t.restore()}}},{key:"_drawRound",value:function(){var e=this.ctx,t=2,i=1;(function n(){var r=this,o=y.getConfig().kList.length;if(o){var a=y.getConfig().kList[o-1],s=a.x,c=a.y,l=a.time,h=y.getConfig().endTime;if(l>=Math.floor(h/1e3-h/1e3%60))return;e.save(),e.beginPath(),e.fillStyle="rgba(71, 127, 211, 1)",e.arc(s,c,2*u,0,2*Math.PI,!0),e.fill(),e.restore(),e.save(),e.fillStyle="rgba(71, 127, 211, 0.28)",e.arc(s,c,t*u,0,2*Math.PI,!0),e.fill(),e.restore(),t>9?(t=9,i*=-1):t<2&&(t=2,i*=-1),t+=i*t/40}requestAnimationFrame((function(){r.draw(),n.call(r,t)}))}).call(this,t)}}]),e}(),k=function(){function e(i){t(this,e),this._canvas=y.getConfig().nodes.xAxis,this._canvas.style.cssText="position: absolute;top: 0;left: 0;width: 100%;height: 100%;",this.ctx=this._canvas.getContext("2d"),this._options=i,this._crossE=0,this.isShowCross=!1,this.draw()}return n(e,[{key:"draw",value:function(e){var t=this.ctx;t.clearRect(0,0,y.getConfig().size.areaCtxWidth,this._canvas.height),t.save(),t.fillStyle="#fff",t.fillRect(0,0,y.getConfig().size.areaCtxWidth,y.getConfig().size.areaCtxHeight),y.getConfig().startTime&&this._drawPoint({x:0,time:y.getConfig().startTime,textAlign:"left",offsetX:2}),y.getConfig().endTime&&this._drawPoint({x:this._canvas.width-1,time:y.getConfig().endTime,textAlign:"right",offsetX:-2}),t.restore(),e&&(this._crossE=e),this.isShowCross&&(e||this._crossE)&&this._drawCrossValue(e)}},{key:"_drawPoint",value:function(e){var t=this.ctx,i=e.textAlign,n=void 0===i?"center":i,r=e.x,o=e.time,a=e.offsetX;t.save(),t.beginPath(),t.translate(.5,.5),t.moveTo(r,0),t.lineTo(r,4*u),t.strokeStyle="#505361",t.lineWidth=1*u,t.stroke();var s=("0"+(new Date(o).getMonth()+1)).substr(-2),c=("0"+new Date(o).getDate()).substr(-2),l=("0"+new Date(o).getHours()).substr(-2),h=("0"+new Date(o).getMinutes()).substr(-2);t.font=y.getConfig().font.normal,t.fillStyle="#505361",t.textAlign=n,t.fillText("".concat(s,"/").concat(c," ").concat(l,":").concat(h),r+a*u,20*u),t.restore()}},{key:"_drawCrossValue",value:function(e){var t=y.getConfig(),i=t.size,n=t.kList,r=t.zoomX,o=x(e||this._crossE,i),a=Math.round(o.x),s=this.ctx,c=C({x:a,zoomX:r},n);if(c){var l=c.time,h=Math.floor(a-40*u),f=80*u,g=i.areaCtxWidth-f,d=Math.floor(h>=0?h<=g?h:g:0),v=d+8*u;s.save(),s.fillStyle="rgb(76,82,94)",s.fillRect(d,0,f,15*u);var p=("0"+(new Date(1e3*l).getMonth()+1)).substr(-2),m=("0"+new Date(1e3*l).getDate()).substr(-2),w=("0"+new Date(1e3*l).getHours()).substr(-2),b=("0"+new Date(1e3*l).getMinutes()).substr(-2);s.font=y.getConfig().font.normal,s.fillStyle="#fff",s.textAlign="left",s.fillText("".concat(p,"/").concat(m," ").concat(w,":").concat(b),v,11*u),s.restore()}}}]),e}(),S=function(){function e(i){t(this,e),y.update({nodes:{container:document.createElement("div"),area:document.createElement("canvas"),areaCross:document.createElement("canvas"),xAxis:document.createElement("canvas")}}),this._init(),this._initDOM(i.el),this.updateChart()}return n(e,[{key:"_init",value:function(){this._instance={area:new P,areaCross:new _,xAxis:new k},this._observer=new b,this._bindEventForAreaCross()}},{key:"_initDOM",value:function(e){var t=y.getConfig().nodes;t.container.id="wrap",t.container.style.cssText="position: relative;width: 100%;height: 100%;display:flex;flex-direction:column;";var i=document.createElement("div");i.id="areaParentElm",i.style.cssText="position: relative;width: 100%;user-select: none;flex: 1;cursor: crosshair;",i.appendChild(t.area),i.appendChild(t.areaCross);var n=document.createElement("div");n.id="xAxisParentElm",n.style.cssText="width: 100%;user-select: none;position: relative;flex:0 0 28px;height: 28px;border-top: 1px solid #505361;box-sizing: border-box;overflow: hidden;",n.appendChild(t.xAxis),t.container.appendChild(i),t.container.appendChild(n),document.querySelector(e).appendChild(t.container)}},{key:"_bindEventForAreaCross",value:function(){var e=this,t=y.getConfig().nodes.areaCross;t.addEventListener(h.start,(function(t){t.preventDefault(),t.stopPropagation(),e._observer.publish(h.start)})),t.addEventListener(h.move,(function(t){t.preventDefault(),t.stopPropagation(),e._instance.areaCross.isShowCross=!0,e._instance.xAxis.isShowCross=!0,e._handleHorizontalScroll(t);var i=y.getConfig(),n=i.zoomX,r=i.kList,o=C({x:x(t,y.getConfig().size).x,zoomX:n},r);e._observer.publish(h.move,o||null)})),t.addEventListener(h.end,(function(t){e._instance.areaCross.isShowCross=!1,e._instance.xAxis.isShowCross=!1,e._observer.publish(h.end),e.updateChart()})),h.leave&&t.addEventListener(h.leave,(function(t){e._instance.areaCross.isShowCross=!1,e._instance.xAxis.isShowCross=!1,e._handleMouseLeave(),e._observer.publish(h.leave),e.updateChart()}))}},{key:"_handleMouseLeave",value:function(){this._instance.areaCross.draw(),this._instance.xAxis.draw()}},{key:"_handleHorizontalScroll",value:function(e){this._instance.areaCross.draw(e),this._instance.xAxis.draw(e)}},{key:"_updateSize",value:function(){var e=this,t=y.getConfig().nodes,i=t.container,n=t.area,r=t.areaCross,o=t.xAxis,a=i.getBoundingClientRect(),s=n.getBoundingClientRect(),c=r.getBoundingClientRect(),l=o.getBoundingClientRect();[n,r,o].forEach((function(t){return e._initSize(t)}));var h={areaRect:s,containerWidth:Math.floor(a.width),areaCtxWidth:Math.floor(s.width*u),areaCtxHeight:Math.floor(s.height*u),areaCrossCtxWidth:Math.floor(c.width*u),areaCrossCtxHeight:Math.floor(c.height*u),xAxisCtxWidth:Math.floor(l.width*u),xAxisCtxHeight:Math.floor(l.height*u)};y.update({size:h,zoomX:this._getZoomX()}),y.update({kList:d(y.getConfig())})}},{key:"_getZoomX",value:function(){return y.getConfig().zoomX}},{key:"_initSize",value:function(e){var t=Math.floor(e.getBoundingClientRect().width),i=Math.floor(e.getBoundingClientRect().height);e.style.width=t+"px",e.style.height=i+"px",e.width=t*u,e.height=i*u}},{key:"subscribe",value:function(e,t){if(!Object.values(h).includes(e))throw new Error("unable to add click event: "+e);this._observer.subscribe(e,t.bind(this))}},{key:"unSubscribe",value:function(e){this._observer.unSubscribe(e)}},{key:"applyConfig",value:function(e){y.update(a({},e)),y.update({zoomX:this._getZoomX()}),this.updateChart()}},{key:"updateChart",value:function(){y.update({kList:d(y.getConfig())}),this._updateSize(),this._instance.area.draw(),this._instance.areaCross.draw(),this._instance.xAxis.draw()}},{key:"resetGlobal",value:function(){y.init()}}]),e}();return e.InitChart=S,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
